import{O as h}from"./index-BoHK0NWw.js";var p={};const d=new h({apiKey:p.OPENAI_API_KEY});class g{async analyzeLead(e){try{const s=this.buildAnalysisPrompt(e),o=(await d.chat.completions.create({model:"gpt-4.1-mini",messages:[{role:"system",content:`You are an expert real estate lead analyst. Your job is to analyze incoming leads and extract key facts, needs, urgency, and provide actionable insights for assignment to the right broker.

Analyze the lead data and provide:
1. Key Facts - Important details about the lead
2. Needs & Requirements - What they're looking for
3. Urgency Level - How quickly they need to act
4. Budget Assessment - Their financial capacity
5. Location Preferences - Where they want to buy
6. Red Flags - Any concerns or issues
7. Recommended Actions - What to do next
8. Broker Match Criteria - What type of broker would be best

Be concise, actionable, and highlight the most important information.`},{role:"user",content:s}],temperature:.7,max_tokens:1e3})).choices[0].message.content,n=this.parseAnalysis(o);return{success:!0,data:{raw_analysis:o,...n,analyzed_at:new Date().toISOString(),model:"gpt-4.1-mini"}}}catch(s){return console.error("Error analyzing lead:",s),{success:!1,error:s.message,data:null}}}buildAnalysisPrompt(e){const s=[];if(s.push("**Lead Information:**"),s.push(`Name: ${e.first_name} ${e.last_name}`),e.email&&s.push(`Email: ${e.email}`),e.phone&&s.push(`Phone: ${e.phone}`),e.budget_min||e.budget_max){const t=e.budget_min&&e.budget_max?`$${e.budget_min.toLocaleString()} - $${e.budget_max.toLocaleString()}`:e.budget_min?`$${e.budget_min.toLocaleString()}+`:e.budget_max?`Up to $${e.budget_max.toLocaleString()}`:"Not specified";s.push(`Budget: ${t}`)}return e.preferred_location&&s.push(`Location: ${e.preferred_location}${e.state?", "+e.state:""}`),e.timeline&&s.push(`Timeline: ${e.timeline}`),e.source&&s.push(`Source: ${e.source}`),e.notes&&(s.push(`
**Additional Notes:**`),s.push(e.notes)),e.source_details&&(s.push(`
**Source Details:**`),e.source_details.campaign_name&&s.push(`Campaign: ${e.source_details.campaign_name}`),e.source_details.platform&&s.push(`Platform: ${e.source_details.platform==="ig"?"Instagram":"Facebook"}`),e.source_details.raw_budget&&s.push(`Original Budget Response: "${e.source_details.raw_budget}"`),e.source_details.raw_location&&s.push(`Original Location Response: "${e.source_details.raw_location}"`),e.source_details.raw_timeline&&s.push(`Original Timeline Response: "${e.source_details.raw_timeline}"`)),s.push(`
**Task:**`),s.push("Analyze this lead and provide actionable insights for assignment to the right broker."),s.join(`
`)}parseAnalysis(e){const s={key_facts:[],needs:[],urgency:"medium",budget_assessment:"",location_preferences:"",red_flags:[],recommended_actions:[],broker_criteria:[]};try{const t={"Key Facts":/(?:Key Facts|Important Details)[:\s]*\n([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Needs:/(?:Needs|Requirements)[:\s]*\n([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Urgency:/(?:Urgency|Timeline)[:\s]*\n?([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Budget:/(?:Budget Assessment|Financial)[:\s]*\n?([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Location:/(?:Location Preferences|Area)[:\s]*\n?([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,"Red Flags":/(?:Red Flags|Concerns|Issues)[:\s]*\n([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Actions:/(?:Recommended Actions|Next Steps)[:\s]*\n([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i,Broker:/(?:Broker Match|Broker Criteria)[:\s]*\n([\s\S]*?)(?=\n\n|\n[A-Z]|$)/i},o=e.match(t["Key Facts"]);o&&(s.key_facts=this.extractBulletPoints(o[1]));const n=e.match(t.Needs);n&&(s.needs=this.extractBulletPoints(n[1]));const i=e.match(t.Urgency);if(i){const a=i[1].toLowerCase();a.includes("high")||a.includes("urgent")||a.includes("asap")?s.urgency="high":(a.includes("low")||a.includes("flexible"))&&(s.urgency="low")}const c=e.match(t.Budget);c&&(s.budget_assessment=c[1].trim());const r=e.match(t.Location);r&&(s.location_preferences=r[1].trim());const u=e.match(t["Red Flags"]);u&&(s.red_flags=this.extractBulletPoints(u[1]));const l=e.match(t.Actions);l&&(s.recommended_actions=this.extractBulletPoints(l[1]));const m=e.match(t.Broker);m&&(s.broker_criteria=this.extractBulletPoints(m[1]))}catch(t){console.error("Error parsing analysis:",t)}return s}extractBulletPoints(e){const s=e.split(`
`),t=[];for(const o of s){const n=o.trim();if(!n)continue;const i=n.replace(/^[-*â€¢]\s*/,"").replace(/^\d+\.\s*/,"").trim();i&&i.length>3&&t.push(i)}return t}suggestBrokerMatch(e,s){const t=s.map(n=>{var c;let i=0;if(e.location_preferences&&n.states_covered){const r=(c=e.location_preferences.match(/\b[A-Z]{2}\b/))==null?void 0:c[0];r&&n.states_covered.includes(r)&&(i+=3)}if(e.broker_criteria&&n.specialties){const r=e.broker_criteria.join(" ").toLowerCase();for(const u of n.specialties)r.includes(u.toLowerCase())&&(i+=2)}return i+=(10-(n.total_listings||0))*.1,{agent:n,score:i}});t.sort((n,i)=>i.score-n.score);const o=t[0];return{agent:o.agent,confidence:o.score>5?"high":o.score>2?"medium":"low",reasoning:this.buildMatchReasoning(o.agent,e)}}buildMatchReasoning(e,s){const t=[];return e.states_covered&&e.states_covered.length>0&&t.push(`Covers ${e.states_covered.join(", ")}`),e.specialties&&e.specialties.length>0&&t.push(`Specializes in ${e.specialties.join(", ")}`),e.years_experience&&t.push(`${e.years_experience} years of experience`),t.join(". ")}}const b=new g;export{b as default,b as leadAgentService};
